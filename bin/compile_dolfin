#!/usr/bin/env python2
from __future__ import print_function

import sys
import os
import pexpect

ddir = os.environ['DOLFIN_DIR']
darch = os.environ['DOLFIN_ARCH']
print("DOLFIN_DIR %s" % ddir)
print("DOLFIN_ARCH %s" % darch)
os.chdir(os.path.join(ddir, darch))


fedora_deps = [
    'eigen3-devel',
    'swig',  # NOTE: you need swig 3.0.3 or newer to use dolfin with python3
    'boost-devel',
    'hdf5-mpich',
    'hdf5-mpich-devel',  # provides the H5pubconf.h file needed for
                         # detection of parallel hdf5 support in
                         # dolfin/cmake
    'hdf5-openmpi',
    'hdf5-openmpi-devel',
    'hdf5-devel',
    'vtk-python',
    'cppunit',
    'qt-devel',
    'jsoncpp',  # also call this:
]

# as swig 3.0.3 was not yet released you have to compile the master branch
# from github
# ./autogen.sh
# ./configure --prefix=$HOME/miniconda/envs/$CONDA_DEFAULT_ENV
# make && make install (ignore the yodl2man error)


# make sure that you patched FindHDF5.cmake
#     set( HDF5_Fortran_HL_LIBRARY_NAMES_INIT hdf5hl_fortran
#          ${HDF5_Fortran_LIBRARY_NAMES_INIT} )
# +   list( APPEND HDF5_INCLUDE_DIRS $ENV{MPI_INCLUDE} )

# missing symlinks (TODO file bug report!)
# _ ln -s /usr/lib64/libjsoncpp.so{.0,}
# _ ln -s /usr/lib64/libjsoncpp.so{.0,}
# _ ln -s /usr/lib64/libnetcdf.so{.7,}

print('(make sure that the following deps are installed\n'
      'di ' + ' '.join(fedora_deps))

cmakeargs = [
    '-DDOLFIN_ENABLE_VTK=1',
    '-DDOLFIN_ENABLE_MPI=1',
    '-DCMAKE_INSTALL_PREFIX=$HOME/miniconda/envs/$CONDA_DEFAULT_ENV',
    '..']
cmakeargs = list(map(os.path.expandvars, cmakeargs))

# make sure to patch CMakeLists.txt (
# TODO: is it possible to replace just the first entry of HDF5_LIBRARIES
# instead of hardcoding all entries in this patch?
# --- a/CMakeLists.txt
# +++ b/CMakeLists.txt
# @@ -447,6 +447,8 @@ if (DOLFIN_ENABLE_HDF5)
#        set(HDF5_FOUND false)
#      endif()
#    endif()
# +
# +  set(HDF5_LIBRARIES "$ENV{MPI_LIB}/libhdf5.so" "/usr/lib64/libz.so" "/usr/lib64/libdl.so" "/usr/lib64/libm.so")
#  endif()

#  # Check for PaStiX
# @@ -569,6 +571,11 @@ if (DOLFIN_ENABLE_VTK)
#        message(STATUS "Found VTK: ${VTK_DIR} (found version \"${VTK_VERSION}\")")
#      endif()
#    endif()
# +
# +  set(VTK_INCLUDE_DIRS "/usr/include/vtk" ${VTK_INCLUDE_DIRS})
# +  message(STATUS "vtk include dirs: ${VTK_INCLUDE_DIRS}")
#  endif()

# NOTE: conda vtk package breaks jit compilation of do.Expression('3') !!!

print("execute cmake %s in %s?" % (' '.join(cmakeargs), os.getcwd()))

p = pexpect.spawn('cmake', cmakeargs, timeout=None, logfile=sys.stdout)
line = p.readline()
while line:
    line = p.readline()

p = pexpect.spawn('make', ['-j4'], timeout=None, logfile=sys.stdout)
line = p.readline()
while line:
    line = p.readline()

p = pexpect.spawn('make', ['install'], timeout=None, logfile=sys.stdout)
line = p.readline()
while line:
    line = p.readline()
